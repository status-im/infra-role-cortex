---
auth_enabled: false

# ---------------------- Limits ---------------------------
limits:
  ingestion_rate: 100000
  ingestion_burst_size: 200000

# ---------------------- MemberList -----------------------
memberlist:
  node_name: '{{ hostname }}'

# ---------------------- Server ---------------------------
server:
  http_listen_address: '0.0.0.0'
  http_listen_port: {{ cortex_listen_port | mandatory }}
  grpc_listen_address: '{{ ansible_local.tinc.vpn_ip }}'
  grpc_listen_port: {{ cortex_grpc_port | mandatory }}
  log_level: '{{ cortex_log_level }}'

  # Big queries need bigger message size
  grpc_server_max_recv_msg_size: 8388608
  grpc_server_max_send_msg_size: 8388608

# ---------------------- Storage --------------------------
storage:
  engine: 'chunks'
  cassandra:
    addresses: '{{ cassandra_nodes | join(',') | trim }}'
    port: {{ cassandra_port | mandatory }}
    SSL: false
    auth: false
    keyspace: '{{ cortex_storage_keyspace_name }}'
    consistency: '{{ cortex_storage_consistency }}'
    replication_factor: {{ cortex_storage_replication_factor }}
  index_queries_cache_config:
    redis:
      endpoint: '{{ cortex_redis_endpoint }}'
      db: {{ cortex_redis_dbs["storage"] }}

# ---------------------- Querier --------------------------
query_range:
  split_queries_by_interval: '168h'
  cache_results: true
  results_cache:
    cache:
      redis:
        endpoint: '{{ cortex_redis_endpoint }}'
        db: {{ cortex_redis_dbs["query_range"] }}

# ---------------------- Frontend Worker ------------------
frontend_worker:
  frontend_address: '{{ cortex_query_frontend_addr }}:{{ cortex_query_frontend_port }}'

# ---------------------- Table Manager --------------------
table_manager:
  retention_deletes_enabled: true
  retention_period: '{{ cortex_storage_retention_period }}'

# ---------------------- Configs --------------------------
configs:
  database:
    # TODO use postgres
    uri: 'memory://'

# ---------------------- Ingester -------------------------
ingester:
  flush_period: '1m'
  retain_period: '5m'
  max_chunk_age: '12h'
  lifecycler:
    interface_names: {{ cortex_listen_interfaces | to_yaml }}
    tokens_file_path: '{{ cortex_wal_dir }}/tokens'
  walconfig:
    wal_enabled: true
    wal_dir: '{{ cortex_wal_dir }}'
    recover_from_wal: true
    checkpoint_enabled: true
    checkpoint_duration: '15m'

# ---------------------- Querier ---------------------------
querier:
  max_concurrent: 20
  timeout: '2m'
