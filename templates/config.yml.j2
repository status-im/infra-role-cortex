---
target: '{{ cortex_target_modules | join(",") }}'
auth_enabled: false

# ---------------------- MemberList -----------------------
memberlist:
  node_name: '{{ hostname }}'

# ---------------------- Configs --------------------------
configs:
  database:
    uri: 'memory://'

# ---------------------- Limits ---------------------------
limits:
  ingestion_rate: 1000000
  ingestion_burst_size: 2000000
  max_series_per_metric: 100000
  # Helps with big purger queries
  max_chunks_per_query: 7000000

# ---------------------- Server ---------------------------
server:
  http_listen_address: '0.0.0.0'
  http_listen_port: {{ cortex_listen_port | mandatory }}
  grpc_listen_address: '0.0.0.0'
  grpc_listen_port: {{ cortex_grpc_port | mandatory }}
  log_level: '{{ cortex_log_level }}'

  # Big queries need bigger message size
  grpc_server_max_recv_msg_size: 104857600
  grpc_server_max_send_msg_size: 16777216
  grpc_server_max_concurrent_streams: 0

  # Avoid RPC timeouts
  grpc_server_keepalive_timeout: 120s
  grpc_server_min_time_between_pings: 5s
  grpc_server_ping_without_stream_allowed: true

# ---------------------- Storage --------------------------
storage:
  engine: '{{ cortex_storage_type }}'

{% if cortex_storage_type == 'blocks' %}
{% if 'ingester' in cortex_target_modules or 'store-gateway' in cortex_target_modules or ['all'] == cortex_target_modules %}
blocks_storage:
  backend: 's3'
  s3:
    endpoint: '{{ cortex_blocks_storage_endpoint }}'
    bucket_name: '{{ cortex_blocks_storage_bucket | mandatory }}'
    access_key_id: '{{ cortex_blocks_storage_key_id | mandatory }}'
    secret_access_key: '{{ cortex_blocks_storage_secret | mandatory }}'
  bucket_store:
    index_cache:
      backend: 'memcached'
      memcached:
        addresses: '{{ cortex_memcached_addresses | join(',') }}'
        timeout: '500ms'
    chunks_cache:
      backend: 'memcached'
      memcached:
        addresses: '{{ cortex_memcached_addresses | join(',') }}'
        timeout: '500ms'
    metadata_cache:
      backend: 'memcached'
      memcached:
        addresses: '{{ cortex_memcached_addresses | join(',') }}'
        timeout: '500ms'

{% endif %}
{% endif %}
{% if cortex_storage_type == 'chunks' %}
storage:
  engine: 'chunks'
  cassandra:
    addresses: '{{ cortex_cassandra_nodes | join(',') | trim }}'
    port: {{ cortex_cassandra_port | mandatory | int }}
    SSL: false
    auth: false
    keyspace: '{{ cortex_chunks_storage_keyspace_name }}'
    consistency: '{{ cortex_chunks_storage_consistency }}'
    replication_factor: {{ cortex_chunks_storage_replication_factor }}
    timeout: '20s'
    max_retries: 2
    num_connections: 2
  index_queries_cache_config:
    memcached:
      batch_size: 16384
      parallelism: 10
    memcached_client:
      addresses: '{{ cortex_memcached_addresses | join(',') }}'
      timeout: '500ms'

  # Required by purger module
  delete_store:
    store: 'cassandra'
    requests_table_name: 'delete_requests'

# ---------------------- Chunks ---------------------------
chunk_store:
  chunk_cache_config:
    memcached:
      batch_size: 16384
      parallelism: 10
    memcached_client:
      addresses: '{{ cortex_memcached_addresses | join(',') }}'
      timeout: '500ms'
  write_dedupe_cache_config:
    memcached:
      batch_size: 16384
      parallelism: 10
    memcached_client:
      addresses: '{{ cortex_memcached_addresses | join(',') }}'
      timeout: '500ms'

{% if 'table-manager' in cortex_target_modules or ['all'] == cortex_target_modules %}
# ---------------------- Table Manager --------------------
table_manager:
  retention_deletes_enabled: true
  retention_period: '{{ cortex_storage_retention_period }}'

{% endif %}
{% endif %}
{% if 'querier' in cortex_target_modules or ['all'] == cortex_target_modules %}
# ---------------------- Querier --------------------------
querier:
  max_samples: 1000000000
  max_concurrent: 100
  timeout: '2m'
  # Should be same as `ingester.max_chunk_age`.
  query_store_after: '2h'

# ---------------------- Frontend Worker ------------------
frontend_worker:
  frontend_address: '{{ cortex_query_frontend_addr }}:{{ cortex_query_frontend_port }}'
  match_max_concurrent: true

{% endif %}
{% if 'querier' in cortex_target_modules or ['all'] == cortex_target_modules %}
# ---------------------- Store Gateway --------------------
store_gateway:
  sharding_enabled: true

{% endif %}
{% if 'query-frontend' in cortex_target_modules or ['all'] == cortex_target_modules %}
# ---------------------- Query Frontend -------------------
frontend:
  max_outstanding_per_tenant: 400
  log_queries_longer_than: 5s
  query_stats_enabled: true
  grpc_client_config:
    max_recv_msg_size: 104857600
    max_send_msg_size: 16777216

# ---------------------- Querier --------------------------
query_range:
  split_queries_by_interval: '24h'
  align_queries_with_step: true
  cache_results: true
  results_cache:
    cache:
      memcached:
        batch_size: 16384
        parallelism: 10
      memcached_client:
        addresses: '{{ cortex_memcached_addresses | join(',') }}'
        timeout: '500ms'

{% endif %}
{% if 'distributor' in cortex_target_modules or ['all'] == cortex_target_modules %}
# ---------------------- Distributor ----------------------
distributor:
  # Low timeout causes ingester `context deadline exceeded`.
  # Should be the same as `querier.query_store_after`.
  remote_timeout: '4s'
  # High Availability Tracker deduplicates samples from redundant Prometheus servers.
  ha_tracker:
    enable_ha_tracker: true

{% endif %}
{% if 'ingester' in cortex_target_modules or ['all'] == cortex_target_modules %}
# ---------------------- Ingester -------------------------
ingester:
  spread_flushes: true
  flush_period: '1m'
  retain_period: '5m'
  # Lowers amount of RAM used at cost of storage I/O.
  # Should be same as `querier.query_store_after`.
  max_chunk_age: '2h'

  lifecycler:
    tokens_file_path: '{{ cortex_wal_dir }}/tokens'
    interface_names: {{ cortex_listen_interfaces | to_yaml }}

{% if cortex_storage_type == 'chunks' %}
  walconfig:
    wal_enabled: true
    checkpoint_enabled: true
    recover_from_wal: true
    checkpoint_duration: '30m'
    wal_dir: '{{ cortex_wal_dir }}'

{% endif %}
{% endif %}
{% if 'purger' in cortex_target_modules or ['all'] == cortex_target_modules %}
# ---------------------- Purger ---------------------------
purger:
  enable: true
  num_workers: 2
  object_store_type: 'inmemory'
  delete_request_cancel_period: '5m'
{% endif %}
